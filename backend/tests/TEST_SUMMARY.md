# æµ‹è¯•æ€»ç»“

## ğŸ“Š æµ‹è¯•è¦†ç›–æ¦‚è§ˆ

æœ¬æµ‹è¯•å¥—ä»¶ä¸ºåç«¯ API æä¾›äº†å…¨é¢çš„æµ‹è¯•è¦†ç›–ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€API æµ‹è¯•å’Œé›†æˆæµ‹è¯•ã€‚

### æµ‹è¯•æ–‡ä»¶ç»Ÿè®¡

| æ–‡ä»¶ | æµ‹è¯•ç±»æ•° | æµ‹è¯•æ–¹æ³•æ•° | è¦†ç›–èŒƒå›´ |
|------|---------|-----------|---------|
| `conftest.py` | - | - | æµ‹è¯•é…ç½®å’Œ fixtures |
| `test_models.py` | 2 | ~20 | æ•°æ®åº“æ¨¡å‹ |
| `test_telemetry_api.py` | 3 | ~30 | Telemetry API |
| `test_chat_api.py` | 4 | ~25 | Chat API |
| `test_services.py` | 1 | ~25 | æœåŠ¡å±‚é€»è¾‘ |
| `test_utils.py` | 7 | ~20 | å·¥å…·å‡½æ•° |
| `test_integration.py` | 5 | ~15 | ç«¯åˆ°ç«¯é›†æˆ |
| **æ€»è®¡** | **22** | **~135** | **å…¨æ ˆè¦†ç›–** |

## ğŸ¯ æµ‹è¯•è¦†ç›–çš„åŠŸèƒ½æ¨¡å—

### 1. æ•°æ®åº“å±‚ (test_models.py)

âœ… **Telemetry æ¨¡å‹**
- åˆ›å»ºå’ŒéªŒè¯é¥æµ‹è®°å½•
- è¯„åˆ†èŒƒå›´çº¦æŸï¼ˆ1-10ï¼‰
- å¿…éœ€å­—æ®µéªŒè¯
- æŸ¥è¯¢å’Œè¿‡æ»¤åŠŸèƒ½

âœ… **ChatSession æ¨¡å‹**
- ä¼šè¯åˆ›å»ºå’Œç®¡ç†
- æ¶ˆæ¯è®¡æ•°è·Ÿè¸ª
- æ—¶é—´æˆ³è‡ªåŠ¨æ›´æ–°

### 2. API å±‚

#### Telemetry API (test_telemetry_api.py)

âœ… **æ ¸å¿ƒåŠŸèƒ½**
- æäº¤ç”¨æˆ·åé¦ˆ
- è·å–åé¦ˆç»Ÿè®¡
- è¯„åˆ†åˆ†å¸ƒæŸ¥è¯¢

âœ… **æ•°æ®éªŒè¯**
- è¯„åˆ†èŒƒå›´éªŒè¯ï¼ˆ1-10ï¼‰
- æ¶ˆæ¯è§’è‰²éªŒè¯
- å¿…éœ€å­—æ®µæ£€æŸ¥
- ç‰¹æ®Šå­—ç¬¦å¤„ç†
- Unicode æ”¯æŒ

âœ… **é”™è¯¯å¤„ç†**
- æ— æ•ˆè¯„åˆ†
- ç¼ºå°‘å¿…éœ€å­—æ®µ
- ç©ºæ¶ˆæ¯åˆ—è¡¨
- æ— æ•ˆæ¶ˆæ¯è§’è‰²

#### Chat API (test_chat_api.py)

âœ… **æ ¸å¿ƒåŠŸèƒ½**
- éæµå¼å¯¹è¯
- æµå¼å¯¹è¯
- æ¸©åº¦å‚æ•°æ§åˆ¶
- å¯¹è¯å†å²ç®¡ç†

âœ… **æ•°æ®éªŒè¯**
- è§’è‰²åç§°éªŒè¯
- æ¶ˆæ¯è§’è‰²éªŒè¯
- æ¸©åº¦èŒƒå›´éªŒè¯ï¼ˆ0.0-2.0ï¼‰
- é•¿æ¶ˆæ¯å¤„ç†
- Unicode æ”¯æŒ

âœ… **é”™è¯¯å¤„ç†**
- æ— æ•ˆè§’è‰²
- AI æœåŠ¡ä¸å¯ç”¨
- è¿æ¥é”™è¯¯
- å†…éƒ¨é”™è¯¯

### 3. æœåŠ¡å±‚ (test_services.py)

âœ… **TelemetryService**
- ä¿å­˜åé¦ˆæ•°æ®
- æŸ¥è¯¢ç”¨æˆ·åé¦ˆ
- è®¡ç®—å¹³å‡è¯„åˆ†
- è·å–è¯„åˆ†åˆ†å¸ƒ
- æŸ¥è¯¢ä½è¯„åˆ†åé¦ˆ
- æ¸…ç†æ—§æ•°æ®

âœ… **æ•°æ®å¤„ç†**
- JSON åºåˆ—åŒ–
- ç‰¹æ®Šå­—ç¬¦å¤„ç†
- é•¿å†…å®¹å¤„ç†
- æ—¶é—´è¿‡æ»¤

### 4. å·¥å…·å‡½æ•° (test_utils.py)

âœ… **è‡ªå®šä¹‰å¼‚å¸¸**
- AppException
- ValidationException
- NotFoundException
- ServiceException

âœ… **Schema éªŒè¯**
- Message éªŒè¯
- Rating éªŒè¯
- ChatRequest éªŒè¯
- TelemetryRequest éªŒè¯

âœ… **é…ç½®ç®¡ç†**
- é»˜è®¤é…ç½®
- ç¯å¢ƒå˜é‡
- CORS è®¾ç½®

âœ… **æ•°æ®åº“æ“ä½œ**
- ä¼šè¯åˆ›å»º
- äº‹åŠ¡ç®¡ç†
- å›æ»šå’Œæäº¤

### 5. é›†æˆæµ‹è¯• (test_integration.py)

âœ… **ç«¯åˆ°ç«¯æµç¨‹**
- å®Œæ•´å¯¹è¯å’Œåé¦ˆæµç¨‹
- å¤šè½®å¯¹è¯
- å¤šç”¨æˆ·åœºæ™¯

âœ… **å¹¶å‘å¤„ç†**
- å¹¶å‘ç”¨æˆ·å¯¹è¯
- å¤šç”¨æˆ·åé¦ˆæäº¤

âœ… **é”™è¯¯æ¢å¤**
- å¤±è´¥é‡è¯•
- æ•°æ®ä¸€è‡´æ€§

âœ… **è¾¹ç•Œæƒ…å†µ**
- è¶…é•¿å¯¹è¯
- å¿«é€Ÿè¿ç»­è¯·æ±‚
- ç‰¹æ®Šå­—ç¬¦å¤„ç†

## ğŸ” æµ‹è¯•è´¨é‡æŒ‡æ ‡

### ä»£ç è¦†ç›–ç‡ç›®æ ‡

- **æ€»ä½“è¦†ç›–ç‡**: > 85%
- **API å±‚**: > 90%
- **æœåŠ¡å±‚**: > 85%
- **æ¨¡å‹å±‚**: > 90%

### æµ‹è¯•ç±»å‹åˆ†å¸ƒ

```
å•å…ƒæµ‹è¯•: ~70 ä¸ª (52%)
API æµ‹è¯•:  ~50 ä¸ª (37%)
é›†æˆæµ‹è¯•: ~15 ä¸ª (11%)
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
cd backend
pytest
```

### è¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•

```bash
# å•å…ƒæµ‹è¯•
pytest tests/test_models.py tests/test_services.py tests/test_utils.py

# API æµ‹è¯•
pytest tests/test_telemetry_api.py tests/test_chat_api.py

# é›†æˆæµ‹è¯•
pytest tests/test_integration.py
```

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
pytest --cov=app --cov-report=html
```

### ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
# åŸºæœ¬è¿è¡Œ
./run_tests.sh

# å¸¦è¦†ç›–ç‡
./run_tests.sh -c

# è¯¦ç»†è¾“å‡º + å¹¶è¡Œ
./run_tests.sh -v -f

# åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•
./run_tests.sh --failed
```

## ğŸ“ˆ æµ‹è¯•è¦†ç›–çš„åœºæ™¯

### æ­£å¸¸æµç¨‹
- âœ… ç”¨æˆ·å‘èµ·å¯¹è¯
- âœ… AI è¿”å›å“åº”
- âœ… ç”¨æˆ·æäº¤åé¦ˆ
- âœ… ç³»ç»Ÿä¿å­˜æ•°æ®
- âœ… æŸ¥è¯¢ç»Ÿè®¡ä¿¡æ¯

### å¼‚å¸¸æµç¨‹
- âœ… æ— æ•ˆè¾“å…¥éªŒè¯
- âœ… AI æœåŠ¡ä¸å¯ç”¨
- âœ… æ•°æ®åº“é”™è¯¯
- âœ… ç½‘ç»œè¶…æ—¶
- âœ… å¹¶å‘å†²çª

### è¾¹ç•Œæƒ…å†µ
- âœ… ç©ºè¾“å…¥
- âœ… è¶…é•¿è¾“å…¥
- âœ… ç‰¹æ®Šå­—ç¬¦
- âœ… Unicode å­—ç¬¦
- âœ… æç«¯è¯„åˆ†å€¼

### æ€§èƒ½åœºæ™¯
- âœ… å¹¶å‘è¯·æ±‚
- âœ… å¤§é‡æ•°æ®
- âœ… é•¿å¯¹è¯å†å²
- âœ… å¿«é€Ÿè¿ç»­è¯·æ±‚

## ğŸ”§ æµ‹è¯•å·¥å…·å’Œæ¡†æ¶

- **pytest**: æµ‹è¯•æ¡†æ¶
- **pytest-asyncio**: å¼‚æ­¥æµ‹è¯•æ”¯æŒ
- **pytest-cov**: è¦†ç›–ç‡æŠ¥å‘Š
- **httpx**: HTTP å®¢æˆ·ç«¯æµ‹è¯•
- **unittest.mock**: Mock å’Œ Patch
- **FastAPI TestClient**: API æµ‹è¯•å®¢æˆ·ç«¯
- **SQLAlchemy**: æ•°æ®åº“æµ‹è¯•

## ğŸ“ æµ‹è¯•æœ€ä½³å®è·µ

### å·²å®ç°çš„æœ€ä½³å®è·µ

1. **ç‹¬ç«‹æ€§**: æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»–æµ‹è¯•
2. **å¯é‡å¤æ€§**: ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼Œæ¯æ¬¡æµ‹è¯•ç»“æœä¸€è‡´
3. **æ¸…æ™°æ€§**: æµ‹è¯•åç§°æè¿°æ€§å¼ºï¼Œæ˜“äºç†è§£
4. **å®Œæ•´æ€§**: è¦†ç›–æ­£å¸¸æµç¨‹ã€å¼‚å¸¸æµç¨‹å’Œè¾¹ç•Œæƒ…å†µ
5. **å¯ç»´æŠ¤æ€§**: ä½¿ç”¨ fixtures å¤ç”¨æµ‹è¯•æ•°æ®å’Œè®¾ç½®
6. **Mock å¤–éƒ¨ä¾èµ–**: AI æœåŠ¡ç­‰å¤–éƒ¨ä¾èµ–éƒ½è¢« mock
7. **å¿«é€Ÿæ‰§è¡Œ**: ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼Œæ”¯æŒå¹¶è¡Œè¿è¡Œ

## ğŸ“ æµ‹è¯•ç¤ºä¾‹

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```python
def test_create_telemetry(test_db: Session):
    """æµ‹è¯•åˆ›å»ºé¥æµ‹è®°å½•"""
    telemetry = Telemetry(
        user_id="test-user-123",
        overall_rating=8,
        comment="å¾ˆå¥½çš„å›ç­”",
        messages='[{"role": "user", "content": "æµ‹è¯•"}]'
    )
    
    test_db.add(telemetry)
    test_db.commit()
    test_db.refresh(telemetry)
    
    assert telemetry.id is not None
    assert telemetry.user_id == "test-user-123"
```

### API æµ‹è¯•ç¤ºä¾‹

```python
def test_submit_feedback_success(client: TestClient):
    """æµ‹è¯•æˆåŠŸæäº¤åé¦ˆ"""
    response = client.post("/api/v1/telemetry", json={
        "user_id": "test-user",
        "rating": {"overall_rating": 8},
        "messages": [{"role": "user", "content": "æµ‹è¯•"}]
    })
    
    assert response.status_code == 200
    assert response.json()["result"] == "ok"
```

### é›†æˆæµ‹è¯•ç¤ºä¾‹

```python
@patch('app.services.ai_service.ai_service.chat')
def test_complete_chat_and_feedback_flow(mock_chat, client):
    """æµ‹è¯•å®Œæ•´çš„å¯¹è¯å’Œåé¦ˆæµç¨‹"""
    # 1. å‘èµ·å¯¹è¯
    chat_response = client.post("/api/v1/chat", json={...})
    assert chat_response.status_code == 200
    
    # 2. æäº¤åé¦ˆ
    feedback_response = client.post("/api/v1/telemetry", json={...})
    assert feedback_response.status_code == 200
```

## ğŸ”„ æŒç»­æ”¹è¿›

### å·²å®Œæˆ
- âœ… å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- âœ… é«˜è¦†ç›–ç‡
- âœ… è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- âœ… è¯¦ç»†çš„æµ‹è¯•æ–‡æ¡£

### æœªæ¥æ”¹è¿›æ–¹å‘
- ğŸ”² æ€§èƒ½æµ‹è¯•
- ğŸ”² å‹åŠ›æµ‹è¯•
- ğŸ”² å®‰å…¨æµ‹è¯•
- ğŸ”² UI è‡ªåŠ¨åŒ–æµ‹è¯•
- ğŸ”² æŒç»­é›†æˆé…ç½®

## ğŸ“ æ”¯æŒ

å¦‚æœ‰æµ‹è¯•ç›¸å…³é—®é¢˜ï¼š
1. æŸ¥çœ‹ [README.md](README.md) è·å–è¯¦ç»†æ–‡æ¡£
2. è¿è¡Œ `./run_tests.sh --help` æŸ¥çœ‹æµ‹è¯•é€‰é¡¹
3. è”ç³»å¼€å‘å›¢é˜Ÿè·å–æ”¯æŒ

---

**æœ€åæ›´æ–°**: 2025-01-16  
**æµ‹è¯•å¥—ä»¶ç‰ˆæœ¬**: 1.0.0  
**ç»´æŠ¤è€…**: Backend Team